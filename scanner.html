<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src * 'self' 'unsafe-inline'; media-src * blob: 'self'; script-src * 'self' 'unsafe-inline' 'unsafe-eval'; worker-src * blob: 'self' https: data:; connect-src * 'self' data: blob:; img-src * data: blob: 'self';">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#00843D">
    <title>BR Mania - Scanner de Produtos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Adicionar QuaggaJS direto via CDN - biblioteca alternativa sem Web Workers -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <!-- API do Google Generative AI -->
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai@0.2.0/dist/index.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            overscroll-behavior: none;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        .header {
            background-color: #00843D;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .header h1 {
            margin: 0;
            padding: 0;
            font-size: 20px;
        }
        .logo {
            max-width: 150px;
            margin-bottom: 5px;
        }
        .back-button {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px;
            z-index: 10;
        }
        .button {
            background-color: #00843D;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 10px 0;
            border-radius: 6px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            -webkit-tap-highlight-color: transparent;
        }
        .button:hover {
            background-color: #00692f;
        }
        .button:active {
            transform: scale(0.98);
        }
        .button i {
            margin-right: 10px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scanner-container {
            width: 100%;
            height: 60vh; /* Aumentar a altura para melhor visualização */
            margin: 15px 0;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
        }
        .scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #interactive {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #interactive canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 280px;
            height: 140px;
            transform: translate(-50%, -50%);
            border: 3px solid #00843D;
            box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            z-index: 10;
            pointer-events: none;
        }
        .scan-line {
            position: absolute;
            width: 280px;
            height: 3px;
            background-color: #00843D;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: scanAnimation 2s linear infinite;
            z-index: 11;
            pointer-events: none;
        }
        @keyframes scanAnimation {
            0% { transform: translate(-50%, -80px); }
            50% { transform: translate(-50%, 80px); }
            100% { transform: translate(-50%, -80px); }
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .status {
            text-align: center;
            padding: 12px;
            background-color: #f1f1f1;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
            font-size: 16px;
        }
        .hidden {
            display: none;
        }
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            .scanner-container {
                height: 65vh;
            }
            .card {
                padding: 12px;
                margin: 10px 0;
            }
            .button {
                padding: 14px 20px;
                font-size: 16px;
            }
            .scan-region {
                width: 240px;
                height: 120px;
            }
        }
        /* iOS specific styles */
        @supports (-webkit-touch-callout: none) {
            .button {
                padding: 15px 20px;
            }
        }
        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #00843D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Dicas para escaneamento */
        .scan-tips {
            text-align: center;
            padding: 10px;
            margin-top: -5px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
        }
        .scan-tips strong {
            color: #00843D;
        }
        
        /* Cantos do scanner para melhor visualização */
        .scan-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 280px;
            height: 140px;
            transform: translate(-50%, -50%);
            z-index: 12;
            pointer-events: none;
        }
        .corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: #FF6B00;
            border-style: solid;
            border-width: 0;
        }
        .top-left {
            top: -3px;
            left: -3px;
            border-top-width: 3px;
            border-left-width: 3px;
            border-top-left-radius: 5px;
        }
        .top-right {
            top: -3px;
            right: -3px;
            border-top-width: 3px;
            border-right-width: 3px;
            border-top-right-radius: 5px;
        }
        .bottom-left {
            bottom: -3px;
            left: -3px;
            border-bottom-width: 3px;
            border-left-width: 3px;
            border-bottom-left-radius: 5px;
        }
        .bottom-right {
            bottom: -3px;
            right: -3px;
            border-bottom-width: 3px;
            border-right-width: 3px;
            border-bottom-right-radius: 5px;
        }
        
        @media (max-width: 480px) {
            .scan-corners {
                width: 240px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-button">
            <i class="material-icons">arrow_back</i>
        </a>
        <img src="https://www.brmania.com.br/wp-content/uploads/2023/01/logo-br-mania-1.png" alt="BR Mania" class="logo">
        <h1>Escaneamento de Produtos</h1>
    </div>

    <div class="container">
        <div class="card">
            <h2>Scanner de Código de Barras</h2>
            
            <div class="scanner-container" id="scanner">
                <div id="interactive" class="viewport" style="width: 100%; height: 100%;"></div>
                <div class="scan-region"></div>
                <div class="scan-line"></div>
                <div class="scan-corners">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                </div>
            </div>
            
            <div class="status" id="scanner-status">
                Aponte a câmera para o código de barras do produto
            </div>
            
            <div class="scan-tips">
                <strong>Dicas:</strong> Mantenha o código de barras centralizado, bem iluminado e a uma distância de 10-15cm da câmera. Evite movimentos bruscos.
            </div>
            
            <button class="button" id="manual-btn">
                <i class="material-icons">edit</i> Entrada Manual
            </button>
            
            <div class="form-group hidden" id="manual-input">
                <label for="barcode-input">Digite o código de barras:</label>
                <input type="text" id="barcode-input" placeholder="Ex: 7891234567890" pattern="[0-9]*" inputmode="numeric">
                <button class="button" id="submit-manual">
                    <i class="material-icons">check</i> Confirmar
                </button>
            </div>
        </div>
        
        <!-- Formulário do produto (aparece após escanear) -->
        <div class="card hidden" id="product-form">
            <h2>Dados do Produto</h2>
            
            <div class="form-group">
                <label for="product-code">Código de barras:</label>
                <input type="text" id="product-code" readonly>
            </div>
            
            <div class="form-group">
                <label for="product-name">Nome do produto:</label>
                <input type="text" id="product-name" placeholder="Digite o nome do produto">
            </div>
            
            <div class="form-group">
                <label for="expiry-date">Data de validade:</label>
                <input type="date" id="expiry-date">
            </div>
            
            <button class="button" id="save-btn">
                <i class="material-icons">save</i> Salvar Produto
            </button>
            
            <button class="button" id="cancel-btn" style="background-color: #777;">
                <i class="material-icons">close</i> Cancelar
            </button>
            
            <button class="button" id="add-to-catalog-btn" style="background-color: #ff6b00; margin-top: 10px; display: none;">
                <i class="material-icons">add_circle</i> Adicionar ao Catálogo Local
            </button>
        </div>
        
        <div class="card" id="debug-panel" style="display: none;">
            <h2>Painel de Debug</h2>
            <div class="form-group">
                <label for="debug-code">Código de teste:</label>
                <input type="text" id="debug-code" placeholder="Ex: 7891000053508">
            </div>
            <button class="button" id="debug-test-btn">
                <i class="material-icons">bug_report</i> Testar Código
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const scannerContainer = document.getElementById('scanner');
            const scannerStatus = document.getElementById('scanner-status');
            const manualBtn = document.getElementById('manual-btn');
            const manualInput = document.getElementById('manual-input');
            const barcodeInput = document.getElementById('barcode-input');
            const submitManual = document.getElementById('submit-manual');
            const productForm = document.getElementById('product-form');
            const productCode = document.getElementById('product-code');
            const productName = document.getElementById('product-name');
            const expiryDate = document.getElementById('expiry-date');
            const saveBtn = document.getElementById('save-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            let quaggaInitialized = false;
            
            // Inicializar a API do Google Generative AI
            const API_KEY = "AIzaSyDI9sEOatq9CYjFjxO5fzsvN3knkD6_omc";
            
            // Banco de dados de produtos conhecidos
            const knownProducts = {
                // Produtos alimentícios
                "7891000053508": "Leite Condensado Moça Nestlé Lata 395g",
                "7896029000016": "Leite Longa Vida Integral Elegê 1L",
                "7891000100103": "Achocolatado Nescau 2.0 Lata 400g",
                "7891150050358": "Café Torrado e Moído Pilão 500g",
                "7896005804316": "Arroz Branco Tipo 1 Tio João 5kg",
                "7896292331190": "Feijão Carioca Camil 1kg",
                "7891024134115": "Macarrão Espaguete Adria 500g",
                "7896062401108": "Maionese Tradicional Hellmann's 500g",
                "7891080147402": "Açúcar Refinado Especial União 1kg",
                "7891030001284": "Farinha de Trigo Dona Benta 1kg",
                "7891098000033": "Óleo de Soja Liza 900ml",
                "7891000252826": "Chocolate ao Leite Nestlé 90g",
                "7891141014529": "Refrigerante Coca-Cola 2L",
                "7891149201003": "Biscoito Recheado Oreo 90g", 
                "7896276060024": "Margarina Qualy 500g",
                "7894000010014": "Água Mineral sem Gás Crystal 510ml",
                // Produtos de higiene e limpeza
                "7891010577100": "Sabonete Dove Original 90g",
                "7500435146425": "Creme Dental Colgate Total 12 90g",
                "7891024132555": "Papel Higiênico Neve Folha Dupla 12 rolos",
                "7896094910157": "Sabão em Pó Omo Multiação 1.6kg",
                "7891020000197": "Detergente Líquido Ypê 500ml",
                // Bebidas
                "7891991000833": "Cerveja Skol Lata 350ml",
                "7894900011517": "Refrigerante Coca-Cola Lata 350ml",
                "7896072042604": "Cerveja Brahma Lata 350ml",
                "7891991010627": "Cerveja Original Lata 350ml",
                "7891991011518": "Cerveja Antarctica Lata 350ml",
                "7896008102992": "Suco Del Valle 1L",
                // Outros populares
                "7891010045326": "Creme para Pentear Seda 295ml",
                "7896090401198": "Amaciante Comfort 1L",
                "7896004006413": "Molho de Tomate Pomarola 340g",
                "7896015511375": "Biscoito Passatempo 130g",
                "7622300991296": "Biscoito Trakinas 126g",
                "7896051129813": "Macarrão Instantâneo Miojo Galinha 85g",
                "7891962037363": "Chocolate Lacta ao Leite 90g",
                "7891962037424": "Chocolate Lacta Meio Amargo 90g",
                "7891991015639": "Cerveja Budweiser 350ml",
                // Produtos BR Mania
                "7896007548613": "Sanduíche Natural BR Mania",
                "7896007548620": "Pão de Queijo BR Mania",
                "7898524303015": "Café BR Mania P 180ml",
                "7898524303022": "Café BR Mania M 300ml",
                "7898524303039": "Café BR Mania G 400ml"
            };
            
            // Iniciar o scanner
            initScanner();
            
            // Botão para mostrar painel de debug (apenas em desenvolvimento)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('debug-panel').style.display = 'block';
                document.getElementById('debug-test-btn').addEventListener('click', function() {
                    const code = document.getElementById('debug-code').value.trim();
                    if (code) {
                        processBarcode(code);
                    } else {
                        alert('Digite um código de barras para testar');
                    }
                });
                
                // Mostrar botão de adicionar ao catálogo
                document.getElementById('add-to-catalog-btn').style.display = 'flex';
                document.getElementById('add-to-catalog-btn').addEventListener('click', function() {
                    const code = productCode.value;
                    const name = productName.value;
                    if (code && name) {
                        try {
                            let localCatalog = JSON.parse(localStorage.getItem('localCatalog') || '{}');
                            localCatalog[code] = name;
                            localStorage.setItem('localCatalog', JSON.stringify(localCatalog));
                            alert(`Produto "${name}" adicionado ao catálogo local com código ${code}`);
                        } catch (e) {
                            console.error('Erro ao adicionar ao catálogo:', e);
                            alert('Erro ao adicionar ao catálogo local');
                        }
                    } else {
                        alert('Código e nome são obrigatórios');
                    }
                });
            }
            
            // Alternar para entrada manual
            manualBtn.addEventListener('click', function() {
                stopQuagga();
                manualInput.classList.toggle('hidden');
                this.classList.toggle('hidden');
            });
            
            // Enviar código manual
            submitManual.addEventListener('click', function() {
                const code = barcodeInput.value.trim();
                if (code) {
                    processBarcode(code);
                } else {
                    alert('Por favor, digite um código de barras válido');
                }
            });
            
            // Salvar produto
            saveBtn.addEventListener('click', function() {
                const name = productName.value.trim();
                const expiry = expiryDate.value;
                
                if (!name) {
                    alert('Por favor, digite o nome do produto');
                    return;
                }
                
                if (!expiry) {
                    alert('Por favor, selecione a data de validade');
                    return;
                }
                
                // Simular salvamento
                saveProduct(productCode.value, name, expiry);
            });
            
            // Cancelar
            cancelBtn.addEventListener('click', function() {
                productForm.classList.add('hidden');
                scannerContainer.classList.remove('hidden');
                scannerStatus.classList.remove('hidden');
                manualBtn.classList.remove('hidden');
                manualInput.classList.add('hidden');
                
                // Reiniciar scanner
                initScanner();
            });
            
            // Função para salvar produto (usando localStorage como exemplo)
            function saveProduct(code, name, expiryDate) {
                try {
                    // Obter produtos existentes
                    let products = [];
                    const storedProducts = localStorage.getItem('products');
                    
                    if (storedProducts) {
                        products = JSON.parse(storedProducts);
                    }
                    
                    // Adicionar novo produto
                    products.push({
                        id: Date.now().toString(),
                        code: code,
                        name: name,
                        expiryDate: expiryDate,
                        createdAt: new Date().toISOString()
                    });
                    
                    // Salvar no localStorage
                    localStorage.setItem('products', JSON.stringify(products));
                    
                    alert('Produto salvo com sucesso!');
                    
                    // Redirecionar para a lista de produtos
                    window.location.href = 'produtos.html';
                    
                } catch (error) {
                    console.error('Erro ao salvar produto:', error);
                    alert('Erro ao salvar produto. Tente novamente.');
                }
            }
            
            // Função para inicializar o Quagga (biblioteca de leitura de códigos de barras)
            function initScanner() {
                scannerStatus.textContent = "Inicializando câmera...";
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    scannerStatus.textContent = "Este navegador não suporta acesso à câmera";
                    manualBtn.click();
                    return;
                }
                
                // Verificar se já está inicializado para evitar duplicação
                if (quaggaInitialized) {
                    stopQuagga();
                }
                
                // Inicializar Quagga com configurações otimizadas
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector("#interactive"),
                        constraints: {
                            width: { min: 800, ideal: 1280, max: 1920 },
                            height: { min: 600, ideal: 720, max: 1080 },
                            facingMode: "environment", // usar câmera traseira
                            aspectRatio: { min: 1, max: 2 }
                        },
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true,
                        debug: {
                            showCanvas: true,
                            showPatches: true,
                            showFoundPatches: true
                        }
                    },
                    numOfWorkers: 0,  // Importante: desativar workers
                    frequency: 5,     // Aumentar a frequência
                    decoder: {
                        readers: [
                            "ean_reader",
                            "ean_8_reader",
                            "code_128_reader",
                            "code_39_reader",
                            "code_93_reader"
                        ],
                        multiple: false,
                        debug: {
                            showCanvas: true,
                            showPatches: true,
                            showFoundPatches: true,
                            showSkeleton: true,
                            showLabels: true,
                            showPatchLabels: true,
                            showRemainingPatchLabels: true,
                            boxFromPatches: {
                                showTransformed: true,
                                showTransformedBox: true,
                                showBB: true
                            }
                        }
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error("Erro ao inicializar Quagga:", err);
                        scannerStatus.textContent = "Erro ao inicializar câmera: " + err;
                        manualBtn.click();
                        return;
                    }
                    
                    quaggaInitialized = true;
                    scannerStatus.textContent = "Aponte a câmera para o código de barras do produto";
                    
                    // Iniciar o scanner
                    Quagga.start();
                    
                    // Adicionar callback para detecção de código de barras
                    Quagga.onDetected(function(result) {
                        if (result && result.codeResult && result.codeResult.code) {
                            const code = result.codeResult.code;
                            console.log("Código detectado:", code);
                            
                            // Verificar se o código tem um tamanho razoável (a maioria tem pelo menos 8 dígitos)
                            if (code.length >= 8) {
                                stopQuagga();
                                processBarcode(code);
                            } else {
                                // Piscar o elemento de scanner para indicar que detectou mas o código é curto demais
                                scannerContainer.style.backgroundColor = "#00843D";
                                setTimeout(() => {
                                    scannerContainer.style.backgroundColor = "#000";
                                }, 300);
                            }
                        }
                    });
                    
                    // Adicionar feedback para processamento
                    Quagga.onProcessed(function(result) {
                        const drawingCtx = Quagga.canvas.ctx.overlay;
                        const drawingCanvas = Quagga.canvas.dom.overlay;
                        
                        if (result) {
                            // Limpar o canvas
                            if (drawingCtx) {
                                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                            }
                            
                            // Desenhar apenas se tivermos um resultado
                            if (result.boxes) {
                                drawingCtx.strokeStyle = "#00F";
                                drawingCtx.lineWidth = 2;
                                
                                for (let i = 0; i < result.boxes.length; i++) {
                                    drawingCtx.beginPath();
                                    drawingCtx.moveTo(result.boxes[i][0], result.boxes[i][1]);
                                    drawingCtx.lineTo(result.boxes[i][0], result.boxes[i][3]);
                                    drawingCtx.lineTo(result.boxes[i][2], result.boxes[i][3]);
                                    drawingCtx.lineTo(result.boxes[i][2], result.boxes[i][1]);
                                    drawingCtx.lineTo(result.boxes[i][0], result.boxes[i][1]);
                                    drawingCtx.stroke();
                                }
                            }
                            
                            // Se já temos um código de barras
                            if (result.codeResult && result.codeResult.code) {
                                const code = result.codeResult.code;
                                scannerStatus.textContent = `Código detectado: ${code}`;
                                
                                // Verificar se o código tem um tamanho razoável
                                if (code.length >= 8) {
                                    drawingCtx.font = "24px Arial";
                                    drawingCtx.fillStyle = "#00843D";
                                    drawingCtx.fillText(`Código: ${code}`, 10, 20);
                                    drawingCtx.strokeStyle = '#00843D';
                                    drawingCtx.lineWidth = 4;
                                }
                                
                                if (result.box) {
                                    drawingCtx.strokeStyle = "#00843D";
                                    drawingCtx.lineWidth = 2;
                                    
                                    drawingCtx.beginPath();
                                    drawingCtx.moveTo(result.box[0], result.box[1]);
                                    drawingCtx.lineTo(result.box[0], result.box[3]);
                                    drawingCtx.lineTo(result.box[2], result.box[3]);
                                    drawingCtx.lineTo(result.box[2], result.box[1]);
                                    drawingCtx.lineTo(result.box[0], result.box[1]);
                                    drawingCtx.stroke();
                                }
                                
                                if (result.line) {
                                    drawingCtx.strokeStyle = "#FF0000";
                                    drawingCtx.beginPath();
                                    drawingCtx.moveTo(result.line[0], result.line[1]);
                                    drawingCtx.lineTo(result.line[2], result.line[3]);
                                    drawingCtx.stroke();
                                }
                            }
                        }
                    });
                });
            }
            
            // Função para parar o Quagga
            function stopQuagga() {
                if (quaggaInitialized) {
                    Quagga.stop();
                    quaggaInitialized = false;
                }
            }
            
            // Processar código de barras escaneado
            function processBarcode(code) {
                // Parar o scanner
                stopQuagga();
                
                // Preencher formulário do produto
                productCode.value = code;
                
                // Mostrar carregamento
                productName.disabled = true;
                productName.value = 'Buscando informações do produto...';
                scannerStatus.textContent = `Processando código: ${code}`;
                
                console.log('Processando código de barras:', code);
                
                // Verificar primeiro no banco de dados local
                if (knownProducts[code]) {
                    console.log('Produto encontrado no banco de dados local');
                    productName.value = knownProducts[code];
                    scannerStatus.textContent = 'Produto encontrado no catálogo!';
                    productName.disabled = false;
                    showProductForm();
                    return;
                }
                
                // Verificar no catálogo local personalizado
                try {
                    const localCatalog = JSON.parse(localStorage.getItem('localCatalog') || '{}');
                    if (localCatalog[code]) {
                        console.log('Produto encontrado no catálogo local');
                        productName.value = localCatalog[code];
                        scannerStatus.textContent = 'Produto encontrado no seu catálogo!';
                        productName.disabled = false;
                        showProductForm();
                        return;
                    }
                } catch (e) {
                    console.error('Erro ao verificar catálogo local:', e);
                }
                
                // Verificar se já encontramos esse produto anteriormente
                try {
                    const tempProducts = JSON.parse(localStorage.getItem('tempProducts') || '{}');
                    if (tempProducts[code]) {
                        console.log('Produto encontrado em cache local');
                        productName.value = tempProducts[code];
                        scannerStatus.textContent = 'Produto encontrado no histórico!';
                        productName.disabled = false;
                        
                        // Esconder scanner e mostrar formulário
                        showProductForm();
                        return;
                    }
                } catch (e) {
                    console.error('Erro ao verificar cache:', e);
                }
                
                console.log('Produto não encontrado localmente, tentando buscar online...');
                // Tentar buscar usando a API do Gemini
                scannerStatus.textContent = `Consultando banco de dados online...`;
                
                fetchProductNameWithGemini(code)
                    .then(productNameResult => {
                        if (productNameResult) {
                            productName.value = productNameResult;
                            scannerStatus.textContent = 'Produto identificado com sucesso!';
                        } else {
                            productName.value = `Produto ${code.substring(0, 3)}-${code.substring(3, 7)}`;
                            scannerStatus.textContent = 'Nome gerado automaticamente';
                        }
                        productName.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erro ao buscar nome do produto:', error);
                        productName.value = `Produto ${code.substring(0, 3)}-${code.substring(3, 7)}`;
                        productName.disabled = false;
                        scannerStatus.textContent = 'Usando nome temporário - edite se necessário';
                    });
                
                // Esconder scanner e mostrar formulário
                showProductForm();
            }
            
            // Função auxiliar para mostrar o formulário de produto
            function showProductForm() {
                scannerContainer.classList.add('hidden');
                scannerStatus.classList.remove('hidden');
                manualBtn.classList.add('hidden');
                manualInput.classList.add('hidden');
                productForm.classList.remove('hidden');
                
                // Deixar a data de validade vazia para que o usuário defina manualmente
                expiryDate.value = '';
            }
            
            // Função para buscar nome do produto usando a API do Gemini
            async function fetchProductNameWithGemini(barcode) {
                try {
                    scannerStatus.textContent = "Consultando API Gemini...";
                    
                    // Inicializa a API
                    const genAI = new googleGenerativeAI.GoogleGenerativeAI(API_KEY);
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    
                    // Criar o prompt - melhorado para obter respostas mais precisas
                    const prompt = `Você é um especialista em produtos de varejo brasileiro.
                    
                    Eu tenho um produto com o código de barras ${barcode}.
                    
                    Por favor, identifique este produto brasileiro com base no código de barras. 
                    
                    Responda APENAS com o nome do produto e sua embalagem/tamanho, sem qualquer explicação adicional, ponto final ou aspas. Exemplo correto: "Leite Condensado Moça Nestlé Lata 395g"
                    
                    Se você não tiver certeza, tente deduzir um nome plausível baseado no código, pois códigos brasileiros frequentemente começam com 789.`;
                    
                    console.log('Enviando prompt para o Gemini:', prompt);
                    
                    // Fazer a requisição com timeout
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Timeout ao consultar API")), 6000)
                    );
                    
                    const resultPromise = model.generateContent(prompt);
                    
                    // Usar Promise.race para implementar o timeout
                    const result = await Promise.race([resultPromise, timeoutPromise]);
                    const response = await result.response;
                    let text = response.text().trim();
                    
                    // Limpar a resposta - remover aspas, pontos finais e ajustar o formato
                    text = text.replace(/^["']|["']$/g, '').replace(/\.$/g, '');
                    
                    console.log('Resposta recebida do Gemini:', text);
                    
                    // Verificar se a resposta faz sentido (tem pelo menos algumas palavras)
                    if (text && text.split(' ').length > 1) {
                        // Armazenar temporariamente o produto encontrado para consultas futuras
                        try {
                            let tempProducts = JSON.parse(localStorage.getItem('tempProducts') || '{}');
                            tempProducts[barcode] = text;
                            localStorage.setItem('tempProducts', JSON.stringify(tempProducts));
                        } catch (e) {
                            console.error('Erro ao salvar produto em cache:', e);
                        }
                        return text;
                    } else {
                        throw new Error("Resposta inválida da API");
                    }
                } catch (error) {
                    console.error('Erro ao consultar API Gemini:', error);
                    
                    // Verificar se há um produto em cache
                    try {
                        const tempProducts = JSON.parse(localStorage.getItem('tempProducts') || '{}');
                        if (tempProducts[barcode]) {
                            console.log('Produto encontrado em cache local');
                            return tempProducts[barcode];
                        }
                    } catch (e) {
                        console.error('Erro ao buscar cache:', e);
                    }
                    
                    // Se chegou aqui, gerar um nome genérico mas significativo
                    return `Produto ${barcode.substring(0, 3)}-${barcode.substring(3, 7)}`;
                }
            }
        });
    </script>
</body>
</html> 