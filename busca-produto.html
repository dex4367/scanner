<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src * 'self' 'unsafe-inline'; media-src * blob: 'self'; script-src * 'self' 'unsafe-inline' 'unsafe-eval'; worker-src * blob: 'self' https: data:; connect-src * 'self' data: blob:; img-src * data: blob: 'self';">
  <title>Scanner de Produtos BR Mania</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00843D;
      --primary-dark: #00632E;
      --bg-color: #f0f2f5;
      --white: #ffffff;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      --radius: 10px;
      --transition: all 0.3s ease;
      --font: 'Poppins', sans-serif;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font);
    }
    
    body {
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    header {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .logo {
      display: block;
      margin: 0 auto;
      max-width: 150px;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }
    
    .btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 16px;
      margin: 8px 0;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    
    footer {
      text-align: center;
      padding: 15px;
      color: #666;
      font-size: 0.8rem;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: white;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    /* Scanner */
    #scanner-container {
      position: relative;
      width: 100%;
      height: 300px;
      overflow: hidden;
      border-radius: var(--radius);
      margin: 15px 0;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 150px;
      border: 2px solid #00843D;
      border-radius: 10px;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
    }
    
    .scan-region::before, .scan-region::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-color: #00843D;
      border-style: solid;
    }
    
    .scan-region::before {
      top: -2px;
      left: -2px;
      border-width: 4px 0 0 4px;
      border-radius: 5px 0 0 0;
    }
    
    .scan-region::after {
      bottom: -2px;
      right: -2px;
      border-width: 0 4px 4px 0;
      border-radius: 0 0 5px 0;
    }
    
    .flash {
      animation: flash 0.5s;
    }
    
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Lista de produtos */
    .product-list {
      background-color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .product-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    
    .product-info h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--primary-dark);
    }
    
    .product-info p {
      margin: 5px 0 0;
      font-size: 0.9rem;
      color: #666;
    }
    
    .empty-list {
      padding: 30px;
      text-align: center;
      color: #999;
    }
    
    .empty-list i {
      font-size: 3rem;
      display: block;
      margin-bottom: 10px;
      color: #ddd;
    }
    
    .date-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      margin-top: 10px;
      font-size: 1rem;
    }
    
    /* Overlay de notificação */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 1001;
    }
    
    .notification.show {
      display: block;
      animation: slideUp 0.3s, fadeOut 0.5s 2s forwards;
    }
    
    @keyframes slideUp {
      from { transform: translate(-50%, 20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEVFNUU1NUY2MkJBMTFFQUFFQTBBRTVENUQxMTBDMUEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEVFNUU1NjA2MkJBMTFFQUFFQTBBRTVENUQxMTBDMUEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0RUU1RTU1RDYyQkExMUVBQUVBMEFFNUQ1RDExMEMxQSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0RUU1RTU1RTYyQkExMUVBQUVBMEFFNUQ1RDExMEMxQSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgWdRMYAAARUSURBVHja7J1JaBRBGIV/J4Mb4h7cUBRciYi4b3jQixAEA4riUTx5ETx48+LBm0dFPIgHD+JBEdGLioqKuICoiHE3LnFfcDcuMVHjnteZhGES05npnu6arrwPPjLDTE9P9+vqrq+qamKpVEoYt+lFE1AAjAPGAeOAccA4YBwwDhgHjAPGAePAaXppQ/2pVCrJNvGPWCyW+e+wLM7qwDgoYvg6gHHAOGAcMA4YB4wDxgHjgHHAOHCCGJugrHI6ndZZf9lrTXNzM9sAGQeMA8YB44BxwDhgHDAOGAeMA8YB44BxwDhgHDAOGAeMA8YB44BxwDhgHDAOGAeMA8YB44BxwDhgHDAOGAdlgDkP0LVp9W6PxWKxQtpA3AZQAGwCsBNQvwEwDhgHjAPGAeOAcVCG9GYTlMqSvAMYB4wDxgHjgHHAOGAcMA4YB4wDxgHjgHHAOGAcMA4YB4wDxgHjgHHAOGAcMA4YB4wDxgHjgHHAOGAcMA5iiZYW1tOMF+YaiUQiMs4DJJYnl2xdH1UAjAPGAeOAcUCJIQVQxPgdcJCJO28AjAPGAeOAcUBxQAEUMWwDZBwwDpxzHoBdwMxS2YC8ARgHjAPGAeOA4oACKGJ8dAGVzY2ttwHjgHHAOGAcUBxQAEWM1wFUVSUil/Z2G4BxwDhgHFAAUAAUQBEjoA+gJBKJyCRV3ABg+vTpsnjxYunTp4+0trbK5cuX5c2bN/qcWbNmyYoVK2To0KHS3Nwsd+7ckdu3b0c2rteuXSvjx4/X/9++fVuuXr0qP378eHUlEpFJ+oWCN10Fad++vdLQ0CA1NTX67+7du0ttba2sW7dOBg0aJP369dPlO3fulMmTJ0dtWCVVVSX9+/eX2tpa6devnx7n7t27Zf369TJ69GgZOnSoLt+1a5fU1dVF3gaIRAAmTJggAwcOlBs3buiyEydOyPTp06WyslJmzpypi+vr6+Xz58+yYMGCKA6tNnSmTJkiAwYMkOvXr+uyEydOyIwZM6SqqkrPePr06aMHfO7cuTJv3rzoCiBSNkBTU5P8/ftXW/shaMju3bsnHz9+lKamJj3wfgPcvXs3igOrB/z+/fv6MTU1NekB9xuAZdu3b5ePHz/K169fIymAyCwHl5eX64Z9+/ZNWlpatOGze/du+fLli3z//l3LwYUW6AdKrqys1E98uHz58kVaW1t148+dO6f/btmyRR9zDa8BtqxIxEEkBDBixAhZtmyZDBkyRMrKyqR379563MGDB6WhoUE/QRYtWiTLly+XESNGRHFYZdSoUbJs2TKpr6+Xnj176htu7ty5erxBDN++fdNxFT8GOHbsWL0OEMUYIBLrAC0tLfLgwQP5+fOnFsHu3bu14XP//n158uSJGkJ//vyRBw8e6GdRZPn1S27evKkPf8wXLFigHx7Pnj0L/PsRTpQIrRe3A8QDN4ANKi0NLPdnAF4HcAC+DcA4YBwwDiiAyC0H2/QvHbYBMg4YB4wDxgEFwC5gEeO3KOwj42wDYBwwDhgHFIAT+CeAAQB1APUa4tTKDwAAAABJRU5ErkJggg==" alt="BR Mania" class="logo">
    <h1>Scanner de Produtos</h1>
  </header>

  <main>
    <button class="btn" id="scannerBtn"><i class="fas fa-qrcode"></i> Escanear Produto</button>
    <button class="btn" id="productListBtn"><i class="fas fa-list"></i> Produtos Cadastrados</button>
    <button class="btn" id="reportBtn"><i class="fas fa-file-pdf"></i> Gerar Relatório</button>
  </main>
  
  <div class="modal" id="scannerModal">
    <div class="modal-content">
      <span class="close" id="closeScanner">&times;</span>
      <h2>Escaneie o código de barras</h2>
      <div id="scanner-container">
        <video id="video" playsinline></video>
        <div class="scan-region"></div>
      </div>
      <div class="form-container">
        <input type="text" id="dataInput" class="date-input" placeholder="Data de validade (DD/MM/AAAA)" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
      </div>
    </div>
  </div>
  
  <div class="modal" id="productListModal">
    <div class="modal-content">
      <span class="close" id="closeProductList">&times;</span>
      <h2>Produtos Cadastrados <span id="productCount">(0)</span></h2>
      <div class="product-list" id="productListContainer">
        <div class="empty-list">
          <i class="fas fa-shopping-bag"></i>
          <p>Nenhum produto cadastrado</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="notification" id="notification"></div>
  
  <footer>
    &copy; 2025 BR Mania - Scanner de Produtos
  </footer>

  <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Armazenamento de produtos
    let produtos = [];
    let scanner = null;
    
    // DOM Elements
    const scannerBtn = document.getElementById('scannerBtn');
    const productListBtn = document.getElementById('productListBtn');
    const reportBtn = document.getElementById('reportBtn');
    const scannerModal = document.getElementById('scannerModal');
    const productListModal = document.getElementById('productListModal');
    const closeScanner = document.getElementById('closeScanner');
    const closeProductList = document.getElementById('closeProductList');
    const productListContainer = document.getElementById('productListContainer');
    const productCount = document.getElementById('productCount');
    const video = document.getElementById('video');
    const notification = document.getElementById('notification');
    const dataInput = document.getElementById('dataInput');
    
    // Event Listeners
    scannerBtn.addEventListener('click', openScanner);
    productListBtn.addEventListener('click', openProductList);
    reportBtn.addEventListener('click', generateReport);
    closeScanner.addEventListener('click', closeModal);
    closeProductList.addEventListener('click', closeModal);
    
    // Formatação de data
    dataInput.addEventListener('input', function() {
      let valor = this.value.replace(/\D/g, '');
      
      if (valor.length > 0) {
        valor = valor.substring(0, 8);
        if (valor.length > 4) {
          valor = `${valor.substring(0, 2)}/${valor.substring(2, 4)}/${valor.substring(4, 8)}`;
        } else if (valor.length > 2) {
          valor = `${valor.substring(0, 2)}/${valor.substring(2, valor.length)}`;
        }
      }
      
      this.value = valor;
    });
    
    // Inicialização
    function initializeScanner() {
      const codeReader = new ZXing.BrowserMultiFormatReader();
      
      codeReader.listVideoInputDevices()
        .then((videoInputDevices) => {
          const firstDevice = videoInputDevices[0].deviceId;
          
          codeReader.decodeFromVideoDevice(
            firstDevice,
            'video',
            (result, err) => {
              if (result) {
                handleScan(result.getText());
              }
              if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error(err);
              }
            }
          );
          
          scanner = codeReader;
        })
        .catch(err => {
          console.error(err);
          showNotification('Erro ao acessar a câmera. Verifique as permissões.');
        });
    }
    
    // Gerenciar scans
    async function handleScan(barcode) {
      // Efeito visual de flash
      document.querySelector('.scan-region').classList.add('flash');
      setTimeout(() => {
        document.querySelector('.scan-region').classList.remove('flash');
      }, 500);
      
      // Buscar produto
      try {
        let productData = null;
        
        // Primeiro tentamos a API do Brasil
        try {
          const res = await fetch(`https://brasilapi.com.br/api/codigos-barra/v1/${barcode}`);
          
          if (res.ok) {
            const data = await res.json();
            if (data && data.nome) {
              productData = {
                codigo: barcode,
                nome: data.nome,
                tipo: data.tipo || 'N/D'
              };
            }
          }
        } catch (err) {
          console.log("Erro na BrasilAPI");
        }
        
        // Se não encontrou, tenta a API alternativa
        if (!productData) {
          try {
            const alternativeRes = await fetch(`https://api.cosmos.bluesoft.com.br/gtins/${barcode}`, {
              method: 'GET',
              headers: {
                'X-Cosmos-Token': 'g3FQ0LCr8G05pMOiDM9YyQ',
                'Content-Type': 'application/json'
              }
            });
            
            if (alternativeRes.ok) {
              const data = await alternativeRes.json();
              if (data && data.description) {
                productData = {
                  codigo: barcode,
                  nome: data.description,
                  marca: data.brand ? data.brand.name : 'N/D'
                };
              }
            }
          } catch (err) {
            console.log("Erro na Cosmos API");
          }
        }
        
        // Se ainda não encontrou, cria produto genérico
        if (!productData) {
          productData = {
            codigo: barcode,
            nome: `Produto ${barcode}`,
            tipo: 'Não identificado'
          };
        }
        
        // Aguardar input de data
        const confirmAdd = confirm(`Produto encontrado: ${productData.nome}\nDeseja adicionar ao inventário?`);
        
        if (confirmAdd) {
          const dataValidade = dataInput.value.trim();
          
          if (dataValidade && !/^\d{2}\/\d{2}\/\d{4}$/.test(dataValidade)) {
            showNotification('Por favor, insira a data no formato DD/MM/AAAA.');
            return;
          }
          
          // Adicionar à lista
          const produto = {
            ...productData,
            data: dataValidade,
            timestamp: new Date().toISOString()
          };
          
          produtos.push(produto);
          updateProductList();
          
          // Limpar campo de data
          dataInput.value = '';
          
          // Feedback
          showNotification(`Produto "${produto.nome}" adicionado com sucesso!`);
          
          // Fechar modal após adicionar
          setTimeout(() => {
            closeModal();
          }, 1500);
        }
      } catch (err) {
        console.error(err);
        showNotification('Erro ao processar o código de barras');
      }
    }
    
    // Funções para abrir/fechar modais
    function openScanner() {
      scannerModal.style.display = 'flex';
      initializeScanner();
    }
    
    function openProductList() {
      updateProductList();
      productListModal.style.display = 'flex';
    }
    
    function closeModal() {
      scannerModal.style.display = 'none';
      productListModal.style.display = 'none';
      
      // Parar o scanner quando fechar o modal
      if (scanner) {
        scanner.reset();
        scanner = null;
      }
    }
    
    // Atualizar a lista de produtos
    function updateProductList() {
      productCount.textContent = `(${produtos.length})`;
      
      if (produtos.length === 0) {
        productListContainer.innerHTML = `
          <div class="empty-list">
            <i class="fas fa-shopping-bag"></i>
            <p>Nenhum produto cadastrado</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      produtos.forEach((produto, index) => {
        html += `
          <div class="product-item">
            <div class="product-info">
              <h3>${produto.nome}</h3>
              <p>Código: ${produto.codigo}</p>
              ${produto.data ? `<p>Validade: ${produto.data}</p>` : ''}
            </div>
            <div class="product-actions">
              <button onclick="removeProduct(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      
      productListContainer.innerHTML = html;
    }
    
    // Remover produto
    function removeProduct(index) {
      if (confirm('Deseja remover este produto?')) {
        produtos.splice(index, 1);
        updateProductList();
        showNotification('Produto removido');
      }
    }
    
    // Gerar relatório PDF
    function generateReport() {
      if (produtos.length === 0) {
        showNotification('Adicione produtos antes de gerar o relatório');
        return;
      }
      
      // Criar PDF usando jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Título
      doc.setFontSize(20);
      doc.setTextColor(0, 132, 61); // Verde BR Mania
      doc.text("RELATÓRIO DE PRODUTOS", 105, 20, { align: "center" });
      
      doc.setFontSize(14);
      doc.text("BR MANIA", 105, 30, { align: "center" });
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0); // Preto
      
      // Data atual
      const dataAtual = new Date().toLocaleDateString('pt-BR');
      doc.text(`Data: ${dataAtual}`, 105, 40, { align: "center" });
      doc.text(`Total de produtos: ${produtos.length}`, 105, 45, { align: "center" });
      
      // Linha divisória
      doc.setDrawColor(0, 132, 61);
      doc.setLineWidth(0.5);
      doc.line(20, 50, 190, 50);
      
      // Produtos
      let y = 60;
      
      produtos.forEach((produto, index) => {
        // Se estiver perto do fim da página, criar nova página
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        
        doc.setFontSize(12);
        doc.setTextColor(0, 132, 61);
        doc.text(`${index + 1}. ${produto.nome}`, 20, y);
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Código: ${produto.codigo}`, 25, y + 6);
        
        if (produto.data) {
          doc.text(`Validade: ${produto.data}`, 25, y + 12);
          y += 18;
        } else {
          y += 12;
        }
      });
      
      // Rodapé
      doc.setDrawColor(0, 132, 61);
      doc.setLineWidth(0.5);
      doc.line(20, 280, 190, 280);
      
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text("BR MANIA - Relatório de Inventário", 105, 287, { align: "center" });
      
      // Salvar PDF
      doc.save(`inventario_brmania_${dataAtual.replace(/\//g, '-')}.pdf`);
      showNotification('Relatório PDF gerado com sucesso!');
    }
    
    // Função para mostrar notificações
    function showNotification(message) {
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Fechar modais ao clicar fora deles
    window.onclick = function(event) {
      if (event.target === scannerModal) {
        closeModal();
      } else if (event.target === productListModal) {
        closeModal();
      }
    };
  </script>
</body>
</html> 